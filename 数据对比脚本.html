<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>å·ç å¯¹æ¯” Â· å¯¼å‡ºå¸¦æ¸ é“åç§°ï¼ˆå¯é€‰åˆ—/ç­›é€‰ï¼‰</title>
    <!-- SheetJS è¯»å†™ Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background: #f5f7fb;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            padding: 20px 16px;
            color: #1e293b;
            line-height: 1.5;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 {
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #0f172a;
        }
        .sub {
            color: #475569;
            margin-bottom: 24px;
            font-size: 0.95rem;
            border-left: 4px solid #3b82f6;
            padding-left: 12px;
            background: #f1f5f9;
            border-radius: 0 8px 8px 0;
            line-height: 1.6;
        }
        .upload-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 28px;
        }
        /* æ€»æ•°æ®åº“å¡ç‰‡ï¼ˆå­—å…¸è¡¨ï¼‰ */
        .master-card {
            flex: 1 1 360px;
            background: white;
            border-radius: 24px;
            padding: 20px 18px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.02);
            border: 1px solid #e2e8f0;
        }
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 14px;
            color: #1e293b;
        }
        .card-title span {
            background: #3b82f6;
            color: white;
            font-size: 0.8rem;
            padding: 2px 10px;
            border-radius: 30px;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            background: #f8fafc;
            border-radius: 16px;
            padding: 24px 12px;
            text-align: center;
            transition: 0.2s;
            cursor: pointer;
            position: relative;
            margin-bottom: 12px;
        }
        .drop-zone.dragover {
            background: #e0f2fe;
            border-color: #0284c7;
        }
        .drop-zone .icon { font-size: 32px; color: #64748b; margin-bottom: 6px; }
        .drop-zone .hint { font-size: 0.9rem; color: #334155; font-weight: 500; }
        .drop-zone .small { font-size: 0.75rem; color: #64748b; margin-top: 8px; }
        .file-info {
            font-size: 0.85rem;
            background: #f1f5f9;
            padding: 8px 12px;
            border-radius: 30px;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            word-break: break-all;
        }
        .select-group {
            margin-top: 16px;
            background: #f1f5f9;
            padding: 14px 12px;
            border-radius: 16px;
        }
        select {
            width: 100%;
            padding: 10px 14px;
            border-radius: 40px;
            border: 1px solid #cbd5e1;
            background: white;
            font-size: 0.9rem;
            outline: none;
            color: #0f172a;
            margin-bottom: 10px;
        }
        select:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
        select:disabled { background: #e2e8f0; color: #64748b; }
        .preview-area {
            margin-top: 16px;
            font-size: 0.8rem;
            border-top: 1px solid #e2e8f0;
            padding-top: 14px;
            max-height: 200px;
            overflow: auto;
        }
        .preview-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            font-size: 0.75rem;
        }
        .preview-table th {
            background: #f1f5f9;
            padding: 8px 6px;
            font-weight: 600;
            color: #1e293b;
            position: sticky;
            top: 0;
        }
        .preview-table td {
            padding: 6px;
            border-bottom: 1px solid #e2e8f0;
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* å·²ä½¿ç”¨æ•°æ®åº“åŒºåŸŸ - å¤šæ–‡ä»¶å¡ç‰‡åˆ—è¡¨ï¼ˆä¸šåŠ¡è¡¨ï¼‰ */
        .used-section {
            flex: 2 1 600px;
            background: white;
            border-radius: 24px;
            padding: 20px 18px;
            border: 1px solid #e2e8f0;
        }
        .used-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        .used-header h3 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        .btn-add {
            background: #0f766e;
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            border: 1px solid #0f766e;
        }
        .btn-add:hover { background: #115e59; }
        .used-file-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 6px;
        }
        .used-file-card {
            background: #f8fafc;
            border-radius: 20px;
            padding: 16px;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        .file-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .file-name {
            font-weight: 700;
            background: #e2e8f0;
            padding: 4px 14px;
            border-radius: 40px;
            font-size: 0.85rem;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .btn-remove {
            background: none;
            border: 1px solid #cbd5e1;
            border-radius: 30px;
            padding: 4px 12px;
            color: #64748b;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-remove:hover {
            background: #fee2e2;
            border-color: #ef4444;
            color: #b91c1c;
        }
        .used-config {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
        }
        .used-col-select {
            flex: 1 1 200px;
        }
        .used-col-select label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 4px;
        }
        .used-preview {
            margin-top: 12px;
            font-size: 0.75rem;
            border-top: 1px dashed #cbd5e1;
            padding-top: 12px;
            max-height: 150px;
            overflow: auto;
        }

        /* æ“ä½œæ  */
        .action-bar {
            background: white;
            padding: 20px 24px;
            border-radius: 24px;
            margin: 24px 0;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
        }
        .match-info {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
        }
        .badge {
            background: #f1f5f9;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 0.9rem;
        }
        .btn {
            background: white;
            border: 1px solid #94a3b8;
            padding: 10px 24px;
            border-radius: 40px;
            font-weight: 600;
            font-size: 0.95rem;
            color: #1e293b;
            cursor: pointer;
            transition: 0.15s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .btn-primary { background: #2563eb; border-color: #2563eb; color: white; }
        .btn-primary:hover { background: #1d4ed8; }
        .btn-success { background: #0f766e; border-color: #0f766e; color: white; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .btn:disabled { opacity: 0.5; pointer-events: none; }

        .result-area {
            background: white;
            border-radius: 24px;
            padding: 20px;
            border: 1px solid #e2e8f0;
            margin-top: 10px;
        }
        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }
        .result-count {
            background: #dcfce7;
            color: #166534;
            padding: 6px 16px;
            border-radius: 30px;
            font-weight: 600;
        }
        .result-table-wrap {
            max-height: 450px;
            overflow: auto;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        /* ----- æ–°å¢ï¼šå¯¼å‡ºé€‰é¡¹é¢æ¿ ----- */
        .export-options {
            margin-top: 20px;
            padding: 16px 20px;
            background: #f8fafc;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
        }
        .export-options h4 {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1rem;
            margin-bottom: 12px;
            color: #0f172a;
        }
        .option-row {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 24px;
            margin-bottom: 12px;
        }
        .column-selector {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 16px;
            background: white;
            padding: 12px 16px;
            border-radius: 20px;
            border: 1px solid #e2e8f0;
            max-height: 150px;
            overflow-y: auto;
        }
        .column-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .channel-filter {
            display: flex;
            align-items: center;
            gap: 10px;
            background: white;
            padding: 8px 16px;
            border-radius: 40px;
            border: 1px solid #e2e8f0;
        }
        .channel-filter input {
            border: none;
            padding: 8px 0;
            width: 180px;
            font-size: 0.9rem;
            outline: none;
            background: transparent;
        }
        .btn-sm {
            padding: 6px 16px;
            font-size: 0.85rem;
        }

        .footer-note {
            margin-top: 32px;
            font-size: 0.8rem;
            color: #64748b;
            text-align: center;
            border-top: 1px solid #e2e8f0;
            padding-top: 24px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ å·ç å¯¹æ¯” Â· å¯¼å‡ºå¸¦æ¸ é“åç§°ï¼ˆå¯é€‰åˆ—/ç­›é€‰ï¼‰</h1>
        <div class="sub">
            âš¡ çº¯æœ¬åœ°è¿è¡Œï¼Œæ–‡ä»¶ä¸ä¸Šä¼ ã€‚ä¸Šä¼ <strong>æ€»æ•°æ®åº“</strong>ï¼ˆå«å·ç ã€å¡å·ã€æ¸ é“åç§°ç­‰ï¼‰ + å¤šä¸ª<strong>å·²ä½¿ç”¨æ•°æ®åº“</strong>ï¼ˆå«å§“åã€è”é€šå·ç ã€å‘å±•äººç­‰ï¼‰ã€‚<br>
            ğŸ”¹ ä¸ºæ€»è¡¨é€‰æ‹©ã€å·ç åŒ¹é…åˆ—ã€‘å’Œã€æ¸ é“åç§°åˆ—ã€‘ï¼›ä¸ºæ¯ä¸ªå·²ç”¨è¡¨é€‰æ‹©ã€è”é€šå·ç åˆ—ã€‘ â†’ ç‚¹å‡»å¯¹æ¯” â†’ å¯¼å‡º<strong style="color:#0f766e;">åŒ¹é…æˆåŠŸçš„å·²ä½¿ç”¨æ•°æ®è¡Œ</strong>ï¼Œå¹¶è‡ªåŠ¨é™„åŠ â€œæ¸ é“åç§°â€åˆ—ã€‚<br>
            ğŸ¯ <strong>æ–°å¢å¯¼å‡ºå¯é€‰é¡¹</strong>ï¼šå¯¹æ¯”å®Œæˆåï¼Œå¯è‡ªç”±å‹¾é€‰éœ€è¦å¯¼å‡ºçš„åˆ—ï¼Œå¹¶æŒ‰æ¸ é“åç§°å…³é”®è¯ç­›é€‰ï¼Œå†è¡Œå¯¼å‡ºã€‚
        </div>

        <!-- åŒåŒºåŸŸå¸ƒå±€ï¼šæ€»æ•°æ®åº“ + å·²ä½¿ç”¨æ•°æ®åº“å¤šæ–‡ä»¶ -->
        <div class="upload-grid">
            <!-- æ€»æ•°æ®åº“å¡ç‰‡ -->
            <div class="master-card">
                <div class="card-title">ğŸ“ æ€»æ•°æ®åº“ï¼ˆå·ç /æ¸ é“å­—å…¸ï¼‰ <span>æ€»è¡¨</span></div>
                <div id="masterDropZone" class="drop-zone">
                    <div class="icon">ğŸ“‚</div>
                    <div class="hint">æ‹–æ‹½Excel æˆ– ç‚¹å‡»ä¸Šä¼ </div>
                    <div class="small">æ”¯æŒ .xlsx, .xls, .csv</div>
                </div>
                <div id="masterFileInfo" class="file-info" style="display: none;"></div>
                
                <div class="select-group">
                    <div style="font-weight:600; font-size:0.9rem; margin-bottom:8px;">ğŸ”– æ€»è¡¨å­—æ®µé…ç½®</div>
                    <select id="masterMatchSelect" disabled>
                        <option value="">â€” è¯·é€‰æ‹©å·ç /å¡å·åŒ¹é…åˆ— â€”</option>
                    </select>
                    <div style="font-size:0.7rem; color:#475569; margin: 0 0 8px;">ç”¨äºå…³è”å·²ä½¿ç”¨è¡¨çš„å·ç å­—æ®µ</div>
                    
                    <select id="masterChannelSelect" disabled>
                        <option value="">â€” è¯·é€‰æ‹©æ¸ é“åç§°åˆ— â€”</option>
                    </select>
                    <div style="font-size:0.7rem; color:#475569; margin-top: 4px;">å¯¼å‡ºæ—¶é™„åŠ çš„æ¸ é“åç§°æ¥æº</div>
                </div>
                <!-- æ€»è¡¨é¢„è§ˆ -->
                <div id="masterPreview" class="preview-area" style="display: none;"></div>
            </div>

            <!-- å·²ä½¿ç”¨æ•°æ®åº“åŒºåŸŸï¼ˆå¯å¤šä¸ªï¼‰ -->
            <div class="used-section">
                <div class="used-header">
                    <h3>ğŸ“‹ å·²ä½¿ç”¨æ•°æ®åº“ï¼ˆä¸šåŠ¡æ•°æ®ï¼Œå¯å¤šä¸ªï¼‰</h3>
                    <button id="addUsedFileBtn" class="btn-add">â• æ·»åŠ å·²ç”¨æ–‡ä»¶</button>
                </div>
                <div id="usedFileListContainer" class="used-file-list">
                    <!-- åŠ¨æ€æ’å…¥ .used-file-card -->
                </div>
                <div id="noUsedFilesHint" style="color: #64748b; padding: 20px; text-align: center; background: #f8fafc; border-radius: 16px; margin-top: 10px;">
                    æš‚æ— å·²ä½¿ç”¨è¡¨æ ¼ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ã€‚
                </div>
            </div>
        </div>

        <!-- æ“ä½œæ ï¼šæ˜¾ç¤ºå½“å‰é…ç½®çŠ¶æ€ + å¯¹æ¯”/å¯¼å‡º -->
        <div class="action-bar">
            <div class="match-info">
                <span class="badge">ğŸ¯ æ€»è¡¨åŒ¹é…åˆ—: <span id="selectedMasterMatchLabel" style="font-weight:700;">æœªé€‰æ‹©</span></span>
                <span class="badge">ğŸ· æ¸ é“åç§°åˆ—: <span id="selectedMasterChannelLabel" style="font-weight:700;">æœªé€‰æ‹©</span></span>
                <span class="badge">ğŸ“¦ å·²ç”¨è¡¨æ•°é‡: <span id="usedFileCount">0</span></span>
            </div>
            <div style="display: flex; gap: 12px;">
                <button id="compareBtn" class="btn btn-primary" disabled>ğŸ” å·ç å¯¹æ¯”</button>
                <button id="exportBtn" class="btn btn-success" disabled>â¬‡ å¯¼å‡ºç»“æœ(å«æ¸ é“)</button>
            </div>
        </div>

        <!-- å¯¹æ¯”ç»“æœåŒºåŸŸï¼šå·²ä½¿ç”¨è¡¨åŸå§‹åˆ— + æ¸ é“åç§° -->
        <div class="result-area" id="resultPanel" style="display: none;">
            <div class="result-header">
                <h3 style="font-size:1.2rem;">ğŸ“‹ åŒ¹é…æˆåŠŸçš„å·²ä½¿ç”¨æ•°æ®ï¼ˆå·²é™„åŠ æ¸ é“åç§°ï¼‰</h3>
                <span id="resultCountBadge" class="result-count">0 è¡Œ</span>
            </div>
            <div id="resultTableContainer" class="result-table-wrap"></div>
            
            <!-- ===== æ–°å¢ï¼šå¯¼å‡ºé€‰é¡¹é¢æ¿ ===== -->
            <div id="exportOptionsPanel" class="export-options" style="display: none;">
                <h4>âš™ï¸ å¯¼å‡ºå¯é€‰é¡¹ï¼ˆå‹¾é€‰éœ€è¦å¯¼å‡ºçš„åˆ—ï¼Œå¯æŒ‰æ¸ é“åç§°ç­›é€‰ï¼‰</h4>
                <div class="option-row">
                    <div style="font-weight: 600; min-width: 80px;">ğŸ“Œ é€‰æ‹©åˆ—ï¼š</div>
                    <div id="columnSelectorContainer" class="column-selector">
                        <!-- åŠ¨æ€ç”Ÿæˆåˆ—å¤é€‰æ¡† -->
                    </div>
                </div>
                <div class="option-row">
                    <div style="font-weight: 600; min-width: 80px;">ğŸ” æ¸ é“ç­›é€‰ï¼š</div>
                    <div class="channel-filter">
                        <span style="color:#0f766e;">ğŸ·</span>
                        <input type="text" id="channelKeywordInput" placeholder="è¾“å…¥æ¸ é“å…³é”®è¯ï¼Œç•™ç©ºä¸è¿‡æ»¤" value="">
                        <span style="color:#64748b; font-size:0.8rem;">ä¸åŒºåˆ†å¤§å°å†™</span>
                    </div>
                    <button id="resetExportOptionsBtn" class="btn btn-sm" style="border-color:#94a3b8;">é‡ç½®ä¸ºå…¨é€‰</button>
                </div>
                <div style="font-size:0.8rem; color:#475569; margin-top: 8px;">
                    * å¯¼å‡ºæ—¶å°†ä»…åŒ…å«å‹¾é€‰çš„åˆ—ï¼Œå¹¶æŒ‰æ¸ é“å…³é”®è¯è¿‡æ»¤ï¼ˆè‹¥å¡«å†™ï¼‰ã€‚
                </div>
            </div>
            <!-- ===== å¯¼å‡ºé€‰é¡¹é¢æ¿ç»“æŸ ===== -->

            <p style="font-size:0.8rem; color:#64748b; margin-top: 12px;">* å¯¼å‡ºExcelåŒ…å«å·²ä½¿ç”¨è¡¨æ‰€æœ‰åŸå§‹åˆ—ï¼ˆå§“åã€è”é€šå·ç ã€å‘å±•äººç­‰ï¼‰+ æ–°å¢â€œæ¸ é“åç§°â€åˆ—ã€‚å¯¼å‡ºæ—¶å¯è‡ªå®šä¹‰åˆ—å’Œç­›é€‰ã€‚</p>
        </div>

        <div class="footer-note">
            âš¡ å…¨ç¨‹æœ¬åœ°å¤„ç† Â· åŸºäºæ‚¨é€‰æ‹©çš„å·ç å­—æ®µè¿›è¡ŒåŒ¹é… Â· æ¯ä¸ªå·²ç”¨è¡¨å¯ç‹¬ç«‹è®¾ç½®åŒ¹é…åˆ— Â· æ¸ é“åç§°å–è‡ªæ€»è¡¨<br>
            ğŸ’¡ è‹¥åŒä¸€å·ç åœ¨æ€»è¡¨ä¸­å¯¹åº”å¤šä¸ªæ¸ é“åç§°ï¼Œä»…å–ç¬¬ä¸€ä¸ªï¼›è‹¥å·²ç”¨è¡¨å·ç åŒ¹é…å¤±è´¥åˆ™ä¸å¯¼å‡ºã€‚ç°åœ¨æ”¯æŒå¯¼å‡ºåˆ—é€‰æ‹©å’Œæ¸ é“å…³é”®è¯ç­›é€‰ã€‚
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // ---------- å…¨å±€çŠ¶æ€ ----------
            // æ€»è¡¨æ•°æ®ï¼ˆå­—å…¸ï¼‰
            let masterHeaders = [];
            let masterRows = [];
            let masterFileName = "";
            let selectedMasterMatchCol = "";   // æ€»è¡¨åŒ¹é…åˆ—ï¼ˆå¦‚å·ç /å¡å·ï¼‰
            let selectedMasterChannelCol = "";  // æ€»è¡¨æ¸ é“åç§°åˆ—

            // å·²ä½¿ç”¨è¡¨æ•°æ®ï¼ˆä¸šåŠ¡è¡¨ï¼Œå¤šä¸ªï¼‰
            let usedFiles = []; // æ¯ä¸ªå…ƒç´ : { id, file, name, headers, rows, selectedMatchCol }

            // åŒ¹é…ç»“æœï¼šä»å·²ä½¿ç”¨è¡¨ä¸­ç­›é€‰å‡ºåŒ¹é…æ€»è¡¨çš„è¡Œï¼Œå¹¶é™„åŠ æ¸ é“åç§°
            let resultRows = []; // æ¯é¡¹: { usedHeaders, usedRow, channelValue }

            // å½“å‰ç»“æœè¡¨å¤´ï¼ˆä»¥ç¬¬ä¸€ä¸ªåŒ¹é…è¡Œçš„è¡¨å¤´ä¸ºåŸºå‡†ï¼‰
            let currentBaseHeaders = [];

            // ---------- å¯¼å‡ºé€‰é¡¹çŠ¶æ€ ----------
            let selectedColumns = [];        // å½“å‰å‹¾é€‰çš„åˆ—åï¼ˆåŒ…å«æ¸ é“åç§°ï¼‰
            let channelKeyword = '';        // æ¸ é“å…³é”®è¯

            // ---------- DOM å…ƒç´  ----------
            const masterDropZone = document.getElementById('masterDropZone');
            const masterFileInfo = document.getElementById('masterFileInfo');
            const masterMatchSelect = document.getElementById('masterMatchSelect');
            const masterChannelSelect = document.getElementById('masterChannelSelect');
            const masterPreview = document.getElementById('masterPreview');
            const selectedMasterMatchLabel = document.getElementById('selectedMasterMatchLabel');
            const selectedMasterChannelLabel = document.getElementById('selectedMasterChannelLabel');

            const addUsedFileBtn = document.getElementById('addUsedFileBtn');
            const usedFileListContainer = document.getElementById('usedFileListContainer');
            const noUsedFilesHint = document.getElementById('noUsedFilesHint');
            const usedFileCountSpan = document.getElementById('usedFileCount');

            const compareBtn = document.getElementById('compareBtn');
            const exportBtn = document.getElementById('exportBtn');
            const resultPanel = document.getElementById('resultPanel');
            const resultCountBadge = document.getElementById('resultCountBadge');
            const resultTableContainer = document.getElementById('resultTableContainer');

            // å¯¼å‡ºé€‰é¡¹ç›¸å…³
            const exportOptionsPanel = document.getElementById('exportOptionsPanel');
            const columnSelectorContainer = document.getElementById('columnSelectorContainer');
            const channelKeywordInput = document.getElementById('channelKeywordInput');
            const resetExportOptionsBtn = document.getElementById('resetExportOptionsBtn');

            // ---------- é€šç”¨å·¥å…· ----------
            function escapeHTML(str) {
                return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
            }

            // è§£æExcel -> { headers, rows }
            function parseExcelToData(ab) {
                const wb = XLSX.read(ab, { type: 'array' });
                const firstSheet = wb.SheetNames[0];
                const sheet = wb.Sheets[firstSheet];
                let data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                if (!data || data.length === 0) return { headers: [], rows: [] };
                let rawHeaders = data[0] || [];
                const processedHeaders = rawHeaders.map((h, idx) => {
                    if (h === undefined || h === null || h === '') return `åˆ—${idx+1}`;
                    return String(h).trim();
                });
                let rows = [];
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    if (Array.isArray(row)) {
                        const newRow = [];
                        for (let j = 0; j < processedHeaders.length; j++) {
                            newRow.push(j < row.length ? (row[j] !== undefined ? row[j] : '') : '');
                        }
                        rows.push(newRow);
                    } else {
                        const emptyRow = new Array(processedHeaders.length).fill('');
                        rows.push(emptyRow);
                    }
                }
                return { headers: processedHeaders, rows };
            }

            // ---------- æ€»è¡¨æ“ä½œ ----------
            function renderMasterPreview() {
                if (!masterHeaders.length || !masterRows.length) {
                    masterPreview.style.display = 'none';
                    return;
                }
                masterPreview.style.display = 'block';
                let html = '<table class="preview-table"><thead><tr>';
                const showCols = Math.min(masterHeaders.length, 8);
                for (let i = 0; i < showCols; i++) html += `<th>${escapeHTML(masterHeaders[i])}</th>`;
                if (masterHeaders.length > 8) html += '<th>â€¦</th>';
                html += '</tr></thead><tbody>';
                for (let r = 0; r < Math.min(masterRows.length, 5); r++) {
                    html += '<tr>';
                    for (let c = 0; c < showCols; c++) {
                        let val = masterRows[r][c] !== undefined ? String(masterRows[r][c]) : '';
                        if (val.length > 15) val = val.slice(0,12)+'â€¦';
                        html += `<td>${escapeHTML(val)}</td>`;
                    }
                    if (masterHeaders.length > 8) html += '<td>â€¦</td>';
                    html += '</tr>';
                }
                html += '</tbody></table>';
                masterPreview.innerHTML = html;
            }

            function populateMasterSelects() {
                masterMatchSelect.innerHTML = '';
                masterChannelSelect.innerHTML = '';
                if (!masterHeaders.length) {
                    masterMatchSelect.disabled = true;
                    masterChannelSelect.disabled = true;
                    masterMatchSelect.innerHTML = '<option value="">â€” æ— åˆ—æ•°æ® â€”</option>';
                    masterChannelSelect.innerHTML = '<option value="">â€” æ— åˆ—æ•°æ® â€”</option>';
                    return;
                }
                masterMatchSelect.disabled = false;
                masterChannelSelect.disabled = false;
                
                // åŒ¹é…åˆ—ä¸‹æ‹‰
                let emptyOpt1 = document.createElement('option');
                emptyOpt1.value = '';
                emptyOpt1.textContent = 'â€” è¯·é€‰æ‹©å·ç /å¡å·åŒ¹é…åˆ— â€”';
                masterMatchSelect.appendChild(emptyOpt1);
                masterHeaders.forEach((h, idx) => {
                    let opt = document.createElement('option');
                    opt.value = h;
                    opt.textContent = `${h} (åˆ—${idx+1})`;
                    masterMatchSelect.appendChild(opt);
                });
                if (selectedMasterMatchCol && masterHeaders.includes(selectedMasterMatchCol)) {
                    masterMatchSelect.value = selectedMasterMatchCol;
                } else {
                    masterMatchSelect.value = '';
                    selectedMasterMatchCol = '';
                }

                // æ¸ é“åç§°åˆ—ä¸‹æ‹‰
                let emptyOpt2 = document.createElement('option');
                emptyOpt2.value = '';
                emptyOpt2.textContent = 'â€” è¯·é€‰æ‹©æ¸ é“åç§°åˆ— â€”';
                masterChannelSelect.appendChild(emptyOpt2);
                masterHeaders.forEach((h, idx) => {
                    let opt = document.createElement('option');
                    opt.value = h;
                    opt.textContent = `${h} (åˆ—${idx+1})`;
                    masterChannelSelect.appendChild(opt);
                });
                if (selectedMasterChannelCol && masterHeaders.includes(selectedMasterChannelCol)) {
                    masterChannelSelect.value = selectedMasterChannelCol;
                } else {
                    masterChannelSelect.value = '';
                    selectedMasterChannelCol = '';
                }
                updateMasterLabels();
            }

            function updateMasterLabels() {
                selectedMasterMatchCol = masterMatchSelect.value || '';
                selectedMasterChannelCol = masterChannelSelect.value || '';
                selectedMasterMatchLabel.textContent = selectedMasterMatchCol || 'æœªé€‰æ‹©';
                selectedMasterChannelLabel.textContent = selectedMasterChannelCol || 'æœªé€‰æ‹©';
            }

            // åˆå§‹åŒ–æ€»è¡¨æ‹–æ‹½ä¸Šä¼ 
            function initMasterDropZone() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls,.csv';
                input.style.display = 'none';
                masterDropZone.appendChild(input);
                const openSelector = () => input.click();
                masterDropZone.addEventListener('click', (e) => { if (e.target.tagName !== 'INPUT') openSelector(); });
                masterDropZone.addEventListener('dragover', (e) => { e.preventDefault(); masterDropZone.classList.add('dragover'); });
                masterDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); masterDropZone.classList.remove('dragover'); });
                masterDropZone.addEventListener('drop', (e) => {
                    e.preventDefault(); masterDropZone.classList.remove('dragover');
                    if (e.dataTransfer.files.length) handleMasterFile(e.dataTransfer.files[0]);
                });
                input.addEventListener('change', (e) => {
                    if (input.files.length) handleMasterFile(input.files[0]);
                    input.value = '';
                });

                const handleMasterFile = (file) => {
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        try {
                            const ab = ev.target.result;
                            const { headers, rows } = parseExcelToData(ab);
                            masterHeaders = headers;
                            masterRows = rows;
                            masterFileName = file.name;
                            masterFileInfo.style.display = 'flex';
                            masterFileInfo.innerHTML = `ğŸ“ ${file.name} (${rows.length}è¡Œ)`;
                            populateMasterSelects();
                            renderMasterPreview();
                            updateMasterLabels();
                            enableButtons();
                        } catch (err) { alert('è§£ææ€»è¡¨å¤±è´¥: ' + err); }
                    };
                    reader.readAsArrayBuffer(file);
                };
            }

            // ---------- å·²ä½¿ç”¨è¡¨å¤šæ–‡ä»¶ç®¡ç† ----------
            function addUsedFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.xlsx,.xls,.csv';
                input.style.display = 'none';
                document.body.appendChild(input);
                input.click();

                input.onchange = (e) => {
                    const file = input.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = (loadEvent) => {
                        try {
                            const ab = loadEvent.target.result;
                            const { headers, rows } = parseExcelToData(ab);
                            const fileId = Date.now() + Math.random();
                            usedFiles.push({
                                id: fileId,
                                file: file,
                                name: file.name,
                                headers: headers,
                                rows: rows,
                                selectedMatchCol: ''
                            });
                            renderUsedFileCards();
                            updateUsedFileCount();
                            enableButtons();
                        } catch (err) {
                            alert('è§£æå·²ä½¿ç”¨è¡¨å¤±è´¥: ' + err);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                    document.body.removeChild(input);
                };
            }

            function renderUsedFileCards() {
                if (usedFiles.length === 0) {
                    usedFileListContainer.innerHTML = '';
                    noUsedFilesHint.style.display = 'block';
                    return;
                }
                noUsedFilesHint.style.display = 'none';
                let html = '';
                usedFiles.forEach((uf) => {
                    html += `<div class="used-file-card" data-id="${uf.id}">
                        <div class="file-card-header">
                            <span class="file-name" title="${escapeHTML(uf.name)}">ğŸ“ ${escapeHTML(uf.name)} (${uf.rows.length}è¡Œ)</span>
                            <button class="btn-remove" onclick="window.removeUsedFile('${uf.id}')">âœ– ç§»é™¤</button>
                        </div>
                        <div class="used-config">
                            <div class="used-col-select">
                                <label>ğŸ“ è”é€šå·ç /åŒ¹é…åˆ—</label>
                                <select id="usedSelect_${uf.id}" onchange="window.updateUsedMatchCol('${uf.id}', this.value)">
                                    ${generateUsedSelectOptions(uf.headers, uf.selectedMatchCol)}
                                </select>
                            </div>
                        </div>
                        <div class="used-preview" id="usedPreview_${uf.id}">
                            ${generateUsedPreviewHTML(uf.headers, uf.rows)}
                        </div>
                    </div>`;
                });
                usedFileListContainer.innerHTML = html;
            }

            function generateUsedSelectOptions(headers, selected) {
                if (!headers.length) return '<option value="">â€” æ— åˆ— â€”</option>';
                let opts = '<option value="">â€” è¯·é€‰æ‹©å·ç åˆ— â€”</option>';
                headers.forEach((h, idx) => {
                    const sel = (h === selected) ? 'selected' : '';
                    opts += `<option value="${escapeHTML(h)}" ${sel}>${escapeHTML(h)} (åˆ—${idx+1})</option>`;
                });
                return opts;
            }

            function generateUsedPreviewHTML(headers, rows) {
                if (!headers.length || !rows.length) return '<div style="color:#64748b;">æ— æ•°æ®é¢„è§ˆ</div>';
                let html = '<table class="preview-table"><thead><tr>';
                const showCols = Math.min(headers.length, 5);
                for (let i = 0; i < showCols; i++) html += `<th>${escapeHTML(headers[i])}</th>`;
                if (headers.length > 5) html += '<th>â€¦</th>';
                html += '</tr></thead><tbody>';
                for (let r = 0; r < Math.min(rows.length, 3); r++) {
                    html += '<tr>';
                    for (let c = 0; c < showCols; c++) {
                        let val = rows[r][c] !== undefined ? String(rows[r][c]) : '';
                        if (val.length > 12) val = val.slice(0,10)+'â€¦';
                        html += `<td>${escapeHTML(val)}</td>`;
                    }
                    if (headers.length > 5) html += '<td>â€¦</td>';
                    html += '</tr>';
                }
                html += '</tbody></table>';
                return html;
            }

            // å…¨å±€ç§»é™¤/æ›´æ–°å‡½æ•°
            window.removeUsedFile = function(id) {
                usedFiles = usedFiles.filter(f => f.id != id);
                renderUsedFileCards();
                updateUsedFileCount();
                enableButtons();
                resultPanel.style.display = 'none';
                exportBtn.disabled = true;
            };

            window.updateUsedMatchCol = function(id, value) {
                const file = usedFiles.find(f => f.id == id);
                if (file) file.selectedMatchCol = value;
                enableButtons();
            };

            function updateUsedFileCount() {
                usedFileCountSpan.textContent = usedFiles.length;
            }

            // ---------- æ§åˆ¶å¯¹æ¯”æŒ‰é’® ----------
            function enableButtons() {
                const masterReady = masterHeaders.length > 0 && selectedMasterMatchCol && selectedMasterChannelCol;
                const usedReady = usedFiles.length > 0 && usedFiles.every(f => f.selectedMatchCol && f.selectedMatchCol.trim() !== '');
                compareBtn.disabled = !(masterReady && usedReady);
                // å¯¼å‡ºæŒ‰é’®ç”±å¯¹æ¯”æˆåŠŸåå¼€å¯
            }

            // ---------- æ ¸å¿ƒå·ç åŒ¹é…é€»è¾‘ ----------
            function performCompare() {
                // 1. æ£€æŸ¥é…ç½®
                if (!masterHeaders.length || !selectedMasterMatchCol || !selectedMasterChannelCol) {
                    alert('è¯·å®Œæ•´é…ç½®æ€»è¡¨ï¼ˆä¸Šä¼ æ–‡ä»¶å¹¶é€‰æ‹©åŒ¹é…åˆ—/æ¸ é“åˆ—ï¼‰');
                    return;
                }
                if (usedFiles.length === 0 || !usedFiles.every(f => f.selectedMatchCol)) {
                    alert('è¯·æ·»åŠ å·²ä½¿ç”¨è¡¨å¹¶ä¸ºæ¯ä¸ªè¡¨é€‰æ‹©å·ç åŒ¹é…åˆ—');
                    return;
                }

                const masterMatchIndex = masterHeaders.indexOf(selectedMasterMatchCol);
                const masterChannelIndex = masterHeaders.indexOf(selectedMasterChannelCol);
                if (masterMatchIndex === -1) { alert(`æ€»è¡¨ä¸­æ‰¾ä¸åˆ°åŒ¹é…åˆ— "${selectedMasterMatchCol}"`); return; }
                if (masterChannelIndex === -1) { alert(`æ€»è¡¨ä¸­æ‰¾ä¸åˆ°æ¸ é“åç§°åˆ— "${selectedMasterChannelCol}"`); return; }

                // 2. æ„å»ºæ€»è¡¨æ˜ å°„ï¼šå·ç  -> æ¸ é“åç§°ï¼ˆå–ç¬¬ä¸€ä¸ªåŒ¹é…è¡Œçš„æ¸ é“å€¼ï¼‰
                const channelMap = new Map();
                masterRows.forEach(row => {
                    if (row.length > masterMatchIndex && row.length > masterChannelIndex) {
                        let key = row[masterMatchIndex];
                        key = (key !== undefined && key !== null) ? String(key).trim() : '';
                        if (key === '') return;
                        if (!channelMap.has(key)) {
                            let channelVal = row[masterChannelIndex];
                            channelVal = (channelVal !== undefined && channelVal !== null) ? String(channelVal).trim() : '';
                            channelMap.set(key, channelVal);
                        }
                    }
                });

                // 3. éå†æ‰€æœ‰å·²ä½¿ç”¨è¡¨ï¼Œç­›é€‰åŒ¹é…è¡Œ
                resultRows = [];
                usedFiles.forEach(uf => {
                    const usedMatchIndex = uf.headers.indexOf(uf.selectedMatchCol);
                    if (usedMatchIndex === -1) {
                        alert(`å·²ä½¿ç”¨è¡¨ "${uf.name}" ä¸­æ‰¾ä¸åˆ°åŒ¹é…åˆ— "${uf.selectedMatchCol}"ï¼Œè¯·é‡æ–°é€‰æ‹©`);
                        return;
                    }
                    uf.rows.forEach(row => {
                        if (row.length > usedMatchIndex) {
                            let usedVal = row[usedMatchIndex];
                            usedVal = (usedVal !== undefined && usedVal !== null) ? String(usedVal).trim() : '';
                            if (usedVal === '') return;
                            if (channelMap.has(usedVal)) {
                                const channelName = channelMap.get(usedVal);
                                resultRows.push({
                                    usedHeaders: uf.headers.slice(),
                                    usedRow: row.slice(),
                                    channel: channelName
                                });
                            }
                        }
                    });
                });

                // 4. è®¾ç½®åŸºå‡†è¡¨å¤´ï¼ˆä»¥ç¬¬ä¸€ä¸ªåŒ¹é…è¡Œçš„è¡¨å¤´ä¸ºå‡†ï¼‰
                if (resultRows.length > 0) {
                    currentBaseHeaders = resultRows[0].usedHeaders.slice();
                } else {
                    currentBaseHeaders = [];
                }

                // 5. æ¸²æŸ“ç»“æœ
                renderResultTable();
                resultPanel.style.display = 'block';
                resultCountBadge.textContent = `${resultRows.length} è¡Œ`;
                exportBtn.disabled = false;

                // 6. æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹é¢æ¿ï¼Œå¹¶åˆå§‹åŒ–åˆ—é€‰æ‹©ï¼ˆå…¨é€‰ï¼‰
                if (resultRows.length > 0) {
                    exportOptionsPanel.style.display = 'block';
                    initColumnSelector();
                } else {
                    exportOptionsPanel.style.display = 'none';
                }
                // æ¸…ç©ºç­›é€‰å…³é”®è¯
                channelKeywordInput.value = '';
                channelKeyword = '';
            }

            // æ¸²æŸ“ç»“æœè¡¨æ ¼ï¼ˆä½¿ç”¨åŸºå‡†è¡¨å¤´ï¼‰
            function renderResultTable() {
                if (resultRows.length === 0) {
                    resultTableContainer.innerHTML = '<p style="padding:20px; text-align:center;">æ— åŒ¹é…è®°å½•</p>';
                    return;
                }
                const headersWithChannel = currentBaseHeaders.concat('æ¸ é“åç§°');
                let html = '<table class="preview-table" style="width:100%;"><thead><tr>';
                headersWithChannel.forEach(h => html += `<th>${escapeHTML(h)}</th>`);
                html += '</tr></thead><tbody>';

                const showRows = resultRows.slice(0, 200);
                showRows.forEach(item => {
                    html += '<tr>';
                    currentBaseHeaders.forEach((colName, idx) => {
                        let val = idx < item.usedRow.length ? item.usedRow[idx] : '';
                        val = val !== undefined ? String(val) : '';
                        if (val.length > 30) val = val.slice(0,27)+'â€¦';
                        html += `<td>${escapeHTML(val)}</td>`;
                    });
                    html += `<td style="color:#0f766e; font-weight:500;">${escapeHTML(item.channel)}</td>`;
                    html += '</tr>';
                });
                if (resultRows.length > 200) {
                    html += '<tr><td colspan="100" style="text-align:center; color:#64748b;">ä»…å±•ç¤ºå‰200è¡Œï¼Œå¯¼å‡ºå°†åŒ…å«å…¨éƒ¨</td></tr>';
                }
                html += '</tbody></table>';
                resultTableContainer.innerHTML = html;
            }

            // ---------- å¯¼å‡ºé€‰é¡¹ï¼šåˆ—é€‰æ‹©å™¨åˆå§‹åŒ– ----------
            function initColumnSelector() {
                if (!currentBaseHeaders.length) return;
                const allColumns = currentBaseHeaders.concat('æ¸ é“åç§°');
                // é»˜è®¤å…¨é€‰
                selectedColumns = allColumns.slice();
                renderColumnCheckboxes(allColumns);
            }

            function renderColumnCheckboxes(allColumns) {
                let html = '';
                allColumns.forEach(col => {
                    const escapedCol = escapeHTML(col);
                    html += `<label class="column-checkbox">
                        <input type="checkbox" value="${escapedCol}" checked onchange="window.handleColumnToggle(this, '${escapedCol}')">
                        <span>${escapedCol}</span>
                    </label>`;
                });
                columnSelectorContainer.innerHTML = html;
            }

            // å…¨å±€ï¼šåˆ—å‹¾é€‰åˆ‡æ¢
            window.handleColumnToggle = function(checkbox, colName) {
                if (checkbox.checked) {
                    if (!selectedColumns.includes(colName)) {
                        selectedColumns.push(colName);
                    }
                } else {
                    selectedColumns = selectedColumns.filter(c => c !== colName);
                }
            };

            // é‡ç½®ä¸ºå…¨é€‰
            function resetExportOptions() {
                if (!currentBaseHeaders.length) return;
                const allColumns = currentBaseHeaders.concat('æ¸ é“åç§°');
                selectedColumns = allColumns.slice();
                // é‡æ–°æ¸²æŸ“å¤é€‰æ¡†å¹¶å…¨éƒ¨å‹¾é€‰
                renderColumnCheckboxes(allColumns);
                // æ¸…ç©ºç­›é€‰å…³é”®è¯
                channelKeywordInput.value = '';
                channelKeyword = '';
            }

            // ç›‘å¬æ¸ é“å…³é”®è¯è¾“å…¥
            channelKeywordInput.addEventListener('input', function(e) {
                channelKeyword = e.target.value.trim();
            });

            resetExportOptionsBtn.addEventListener('click', function() {
                resetExportOptions();
            });

            // ---------- å¯¼å‡ºç»“æœï¼ˆæ ¹æ®å¯¼å‡ºé€‰é¡¹ï¼‰----------
            function exportResult() {
                if (resultRows.length === 0) {
                    alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
                    return;
                }
                // 1. è·å–å½“å‰é€‰ä¸­çš„åˆ—
                if (!selectedColumns || selectedColumns.length === 0) {
                    alert('è¯·è‡³å°‘å‹¾é€‰ä¸€åˆ—å¯¼å‡º');
                    return;
                }

                // 2. æ¸ é“ç­›é€‰
                let filteredRows = resultRows;
                if (channelKeyword !== '') {
                    const keyword = channelKeyword.toLowerCase();
                    filteredRows = resultRows.filter(item => 
                        item.channel && item.channel.toLowerCase().includes(keyword)
                    );
                    if (filteredRows.length === 0) {
                        alert('å½“å‰æ¸ é“å…³é”®è¯ç­›é€‰åæ— æ•°æ®ï¼Œè¯·è°ƒæ•´å…³é”®è¯');
                        return;
                    }
                }

                // 3. æ„å»ºå¯¼å‡ºè¡¨å¤´ï¼šselectedColumns
                const exportHeaders = selectedColumns.slice();
                const exportData = [exportHeaders];

                // 4. æ„å»ºæ¯ä¸€è¡Œï¼šéœ€è¦æŒ‰ selectedColumns çš„é¡ºåºå–å€¼
                //    åŸºå‡†è¡¨å¤´ + æ¸ é“åç§° çš„é¡ºåºæ˜¯å›ºå®šçš„
                const baseCols = currentBaseHeaders;          // ä¸šåŠ¡è¡¨åˆ—åæ•°ç»„
                const channelColName = 'æ¸ é“åç§°';

                filteredRows.forEach(item => {
                    const row = [];
                    selectedColumns.forEach(col => {
                        if (col === channelColName) {
                            row.push(item.channel);
                        } else {
                            const idx = baseCols.indexOf(col);
                            if (idx !== -1 && idx < item.usedRow.length) {
                                let val = item.usedRow[idx];
                                val = (val !== undefined && val !== null) ? String(val) : '';
                                row.push(val);
                            } else {
                                row.push(''); // åˆ—ä¸å­˜åœ¨åˆ™å¡«ç©º
                            }
                        }
                    });
                    exportData.push(row);
                });

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exportData);
                XLSX.utils.book_append_sheet(wb, ws, 'å·ç å¯¹æ¯”_å¸¦æ¸ é“');
                const fileName = `å·ç å¯¹æ¯”ç»“æœ_${new Date().getTime()}.xlsx`;
                XLSX.writeFile(wb, fileName);
            }

            // ---------- äº‹ä»¶ç»‘å®š ----------
            masterMatchSelect.addEventListener('change', function() {
                updateMasterLabels();
                enableButtons();
            });
            masterChannelSelect.addEventListener('change', function() {
                updateMasterLabels();
                enableButtons();
            });

            addUsedFileBtn.addEventListener('click', function() {
                addUsedFile();
            });

            compareBtn.addEventListener('click', function() {
                performCompare();
            });

            exportBtn.addEventListener('click', function() {
                exportResult();
            });

            // åˆå§‹åŒ–æ€»è¡¨æ‹–æ‹½
            initMasterDropZone();

            // åˆå§‹çŠ¶æ€
            updateUsedFileCount();
            enableButtons();
            selectedMasterMatchLabel.textContent = 'æœªé€‰æ‹©';
            selectedMasterChannelLabel.textContent = 'æœªé€‰æ‹©';
        })();
    </script>
</body>
</html>